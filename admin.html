<!DOCTYPE html>
<html lang="pl" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Marc Tessens</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Source+Sans+Pro:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    
    <!-- Enhanced Firebase configuration with real-time listeners -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, onValue, off, remove, push, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBFPLvEIK5B48Ldm44bMjGPVyCPbOfrANg",
            authDomain: "marc-tessens.firebaseapp.com",
            databaseURL: "https://marc-tessens-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "marc-tessens",
            storageBucket: "marc-tessens.firebasestorage.app",
            messagingSenderId: "121454227452",
            appId: "1:121454227452:web:a2756542378505f8a08c79"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const firebaseDb = getDatabase(app);
        
        // Make Firebase available globally
        window.firebaseApp = app;
        window.firebaseDb = firebaseDb;
        window.firebaseRef = ref;
        window.firebaseGet = get;
        window.firebaseOnValue = onValue;
        window.firebaseOff = off;
        window.firebaseRemove = remove;
        window.firebasePush = push;
        window.firebaseSet = set;
        
        console.log("[v0] Firebase initialized for admin panel");
        
        // Notify that Firebase is ready
        window.dispatchEvent(new CustomEvent('firebaseAdminReady'));
    </script>
</head>
<body class="font-source bg-gray-50 text-gray-700">
    <!-- Loading overlay -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-lg text-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-800 mx-auto mb-4"></div>
            <p class="text-gray-700">Ładowanie...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <!-- Changed login screen background gradient to blue -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-blue-100">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
            <div class="text-center mb-8">
                <!-- Changed login title color to blue -->
                <h1 class="font-playfair text-3xl font-bold text-blue-800 mb-2">Admin Panel</h1>
                <p class="text-gray-600">Marc Tessens Boekhouding</p>
            </div>
            
            <form id="login-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Gebruikersnaam</label>
                    <!-- Changed input focus ring color to blue -->
                    <input type="text" id="admin-username" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="admin">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Wachtwoord</label>
                    <input type="password" id="admin-password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="••••••••">
                </div>
                
                <!-- Changed login button color to blue -->
                <button type="submit" class="w-full bg-blue-800 hover:bg-blue-900 text-white font-semibold py-3 rounded-lg transition-colors">
                    Inloggen
                </button>
            </form>
            
            <div id="login-error" class="hidden mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                Ongeldige inloggegevens. Probeer opnieuw.
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="hidden min-h-screen">
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <!-- Changed dashboard title color to blue -->
                        <h1 class="font-playfair text-2xl font-bold text-blue-800">Admin Dashboard</h1>
                        <span class="ml-4 text-gray-500">Marc Tessens</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <!-- Enhanced notification bell with persistent storage and better live updates -->
                        <div class="relative">
                            <!-- Changed notification bell hover color to blue -->
                            <button onclick="toggleNotifications()" class="text-gray-500 hover:text-blue-800 relative">
                                <i class="fas fa-bell text-xl"></i>
                                <span id="notification-badge" class="hidden absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center animate-pulse">0</span>
                            </button>
                            
                            <!-- Enhanced notification dropdown with better styling -->
                            <div id="notification-dropdown" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-lg border z-50">
                                <div class="p-4 border-b border-gray-200">
                                    <div class="flex justify-between items-center">
                                        <h3 class="font-semibold text-gray-900">Live Meldingen</h3>
                                        <!-- Changed notification button color to blue -->
                                        <button onclick="markAllNotificationsRead()" class="text-sm text-blue-600 hover:text-blue-800">
                                            Alles markeren als gelezen
                                        </button>
                                        <!-- Added clear notifications button -->
                                        <button onclick="clearAllNotifications()" class="text-sm text-red-600 hover:text-red-800 ml-2">
                                            Wis alle meldingen
                                        </button>
                                    </div>
                                </div>
                                <div id="notification-list" class="max-h-96 overflow-y-auto">
                                    <div class="p-4 text-center text-gray-500">
                                        Geen nieuwe meldingen
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="refreshDashboard()" class="text-gray-500 hover:text-blue-800">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button onclick="resetAllBookings()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm">
                            <i class="fas fa-trash-alt mr-2"></i>Reset
                        </button>
                        <button onclick="adminLogout()" class="text-gray-500 hover:text-red-600">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid md:grid-cols-4 gap-6 mb-8">
                <div class="admin-card bg-white p-6 rounded-lg shadow">
                    <div class="flex items-center">
                        <!-- Changed stats card icon background to blue -->
                        <div class="p-3 bg-blue-100 rounded-lg">
                            <i class="fas fa-calendar-check text-blue-800 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">Totaal Afspraken</p>
                            <p id="total-bookings" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="admin-card bg-white p-6 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-3 bg-yellow-100 rounded-lg">
                            <i class="fas fa-clock text-yellow-700 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">Komende Afspraken</p>
                            <p id="upcoming-bookings" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="admin-card bg-white p-6 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-3 bg-blue-100 rounded-lg">
                            <i class="fas fa-calendar-day text-blue-700 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">Vandaag</p>
                            <p id="today-bookings" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="admin-card bg-white p-6 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-3 bg-purple-100 rounded-lg">
                            <i class="fas fa-envelope text-purple-700 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">Berichten</p>
                            <p id="total-messages" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Added manual appointment creation section -->
            <div class="bg-white rounded-lg shadow mb-8">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-semibold text-gray-900">Manuele Afspraak Toevoegen</h2>
                        <button onclick="toggleManualBookingForm()" id="toggle-manual-booking" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                            <i class="fas fa-plus mr-2"></i>Nieuwe Afspraak
                        </button>
                    </div>
                </div>
                
                <div id="manual-booking-form" class="hidden p-6">
                    <form onsubmit="submitManualBooking(event)" class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Klant Naam *</label>
                            <input type="text" id="manual-name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Volledige naam">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">E-mailadres *</label>
                            <input type="email" id="manual-email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="email@voorbeeld.be">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Telefoonnummer</label>
                            <input type="tel" id="manual-phone" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="+32 XXX XX XX XX">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Type Consultatie *</label>
                            <select id="manual-type" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Selecteer een optie</option>
                                <option value="startup">Startersadvies</option>
                                <option value="bookkeeping">Boekhouding</option>
                                <option value="tax">Fiscaal Advies</option>
                                <option value="payroll">Loonbeheer</option>
                                <option value="other">Andere</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Datum *</label>
                            <input type="date" id="manual-date" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Starttijd *</label>
                            <input type="time" id="manual-start-time" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Eindtijd</label>
                            <input type="time" id="manual-end-time" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-1">Laat leeg voor standaard 30 minuten</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Duur (minuten)</label>
                            <input type="number" id="manual-duration" min="15" max="480" step="15" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="30">
                            <p class="text-xs text-gray-500 mt-1">Alternatief voor eindtijd</p>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Notities</label>
                            <textarea id="manual-notes" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Aanvullende informatie..."></textarea>
                        </div>
                        
                        <div class="md:col-span-2 flex gap-3">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">
                                <i class="fas fa-save mr-2"></i>Afspraak Opslaan
                            </button>
                            <button type="button" onclick="cancelManualBooking()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2 rounded-lg transition-colors">
                                <i class="fas fa-times mr-2"></i>Annuleren
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Added date blocking section -->
            <div class="bg-white rounded-lg shadow mb-8">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-semibold text-gray-900">Datum Blokkering</h2>
                        <button onclick="toggleDateBlockingForm()" id="toggle-date-blocking" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm">
                            <i class="fas fa-ban mr-2"></i>Datum Blokkeren
                        </button>
                    </div>
                </div>
                
                <div id="date-blocking-form" class="hidden p-6">
                    <form onsubmit="submitDateBlocking(event)" class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Van Datum *</label>
                            <input type="date" id="block-start-date" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tot Datum</label>
                            <input type="date" id="block-end-date" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-1">Laat leeg voor één dag</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Starttijd (optioneel)</label>
                            <input type="time" id="block-start-time" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-1">Laat leeg voor hele dag</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Eindtijd (optioneel)</label>
                            <input type="time" id="block-end-time" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Reden voor Blokkering *</label>
                            <input type="text" id="block-reason" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Bijv. Vakantie, Ziek, Vergadering...">
                        </div>
                        
                        <div class="md:col-span-2 flex gap-3">
                            <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg transition-colors">
                                <i class="fas fa-ban mr-2"></i>Datum Blokkeren
                            </button>
                            <button type="button" onclick="cancelDateBlocking()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2 rounded-lg transition-colors">
                                <i class="fas fa-times mr-2"></i>Annuleren
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Blocked dates list -->
                <div id="blocked-dates-list" class="p-6 border-t border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Geblokkeerde Datums</h3>
                    <div id="blocked-dates-container" class="space-y-2">
                        <!-- Blocked dates will be populated here -->
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow mb-8">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-semibold text-gray-900">Afspraken Beheer</h2>
                        <div class="flex space-x-2">
                            <select id="filter-status" onchange="filterBookings()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="all">Alle afspraken</option>
                                <option value="upcoming">Komende afspraken</option>
                                <option value="today">Vandaag</option>
                                <option value="past">Voorbije afspraken</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Datum & Tijd</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Klant</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acties</th>
                            </tr>
                        </thead>
                        <tbody id="bookings-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Bookings will be populated here -->
                        </tbody>
                    </table>
                    
                    <div id="no-bookings" class="hidden p-8 text-center text-gray-500">
                        <i class="fas fa-calendar-times text-4xl mb-4"></i>
                        <p>Geen afspraken gevonden</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900">Berichten</h2>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Datum</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Van</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Onderwerp</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acties</th>
                            </tr>
                        </thead>
                        <tbody id="messages-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Messages will be populated here -->
                        </tbody>
                    </table>
                    
                    <div id="no-messages" class="hidden p-8 text-center text-gray-500">
                        <i class="fas fa-envelope-open text-4xl mb-4"></i>
                        <p>Geen berichten gevonden</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let db = null;
        let allBookings = [];
        let filteredBookings = [];
        let allMessages = [];
        let blockedDates = [];
        let notifications = [];
        let bookingsListener = null;
        let messagesListener = null;
        let blockedDatesListener = null;
        let lastBookingCount = 0;
        let lastMessageCount = 0;
        let notificationStorage = 'marc-tessens-notifications';

        function loadStoredNotifications() {
            try {
                const stored = localStorage.getItem(notificationStorage);
                if (stored) {
                    notifications = JSON.parse(stored);
                    // Convert timestamp strings back to Date objects
                    notifications.forEach(n => {
                        n.timestamp = new Date(n.timestamp);
                    });
                    updateNotificationBadge();
                    renderNotifications();
                }
            } catch (error) {
                console.error('[v0] Error loading stored notifications:', error);
                notifications = [];
            }
        }

        function saveNotifications() {
            try {
                localStorage.setItem(notificationStorage, JSON.stringify(notifications));
            } catch (error) {
                console.error('[v0] Error saving notifications:', error);
            }
        }

        function initializeFirebaseAdmin() {
            if (window.firebaseDb) {
                db = window.firebaseDb;
                console.log("[v0] Firebase Admin initialized successfully!");
                return true;
            }
            return false;
        }

        function initializeNotifications() {
            if (!db) {
                console.error("[v0] Database not initialized for notifications");
                return;
            }

            console.log("[v0] Initializing real-time notifications...");
            
            // Load stored notifications first
            loadStoredNotifications();
            
            // Set up real-time listeners for new bookings
            const bookingsRef = window.firebaseRef(db, "bookings");
            bookingsListener = window.firebaseOnValue(bookingsRef, (snapshot) => {
                if (snapshot.exists()) {
                    const bookingsData = snapshot.val();
                    const currentBookingCount = Object.keys(bookingsData).length;
                    
                    // Check for new bookings (including backlog when first loading)
                    if (lastBookingCount === 0) {
                        // First load - check for any existing bookings as backlog
                        const existingBookings = Object.entries(bookingsData).map(([id, booking]) => ({ id, ...booking }));
                        existingBookings.forEach(booking => {
                            const bookingTime = new Date(booking.created);
                            const now = new Date();
                            const timeDiff = now - bookingTime;
                            
                            // Show as backlog if booking is less than 24 hours old and not seen before
                            if (timeDiff < 24 * 60 * 60 * 1000) {
                                const existingNotification = notifications.find(n => 
                                    n.type === 'booking' && n.message.includes(booking.name) && n.message.includes(booking.date)
                                );
                                
                                if (!existingNotification) {
                                    addNotification(
                                        'booking', 
                                        `Nieuwe afspraak: ${booking.name} op ${formatDate(booking.date)} om ${booking.time}`, 
                                        'fas fa-calendar-plus', 
                                        'bg-green-100 text-green-800',
                                        false // Don't play sound for backlog
                                    );
                                }
                            }
                        });
                    } else if (currentBookingCount > lastBookingCount) {
                        // New booking since last check
                        const newBookings = Object.entries(bookingsData)
                            .slice(-1) // Get the last booking
                            .map(([id, booking]) => ({ id, ...booking }));
                        
                        newBookings.forEach(booking => {
                            addNotification(
                                'booking', 
                                `Nieuwe afspraak: ${booking.name} op ${formatDate(booking.date)} om ${booking.time}`, 
                                'fas fa-calendar-plus', 
                                'bg-green-100 text-green-800',
                                true // Play sound for new bookings
                            );
                        });
                    }
                    
                    lastBookingCount = currentBookingCount;
                    
                    // Update bookings data
                    allBookings = Object.entries(bookingsData).map(([id, booking]) => ({ id, ...booking }));
                    filterBookings();
                    updateStats();
                }
            });
            
            // Set up real-time listeners for new messages
            const messagesRef = window.firebaseRef(db, "messages");
            messagesListener = window.firebaseOnValue(messagesRef, (snapshot) => {
                if (snapshot.exists()) {
                    const messagesData = snapshot.val();
                    const currentMessageCount = Object.keys(messagesData).length;
                    
                    // Check for new messages (including backlog when first loading)
                    if (lastMessageCount === 0) {
                        // First load - check for any existing messages as backlog
                        const existingMessages = Object.entries(messagesData).map(([id, message]) => ({ id, ...message }));
                        existingMessages.forEach(message => {
                            const messageTime = new Date(message.created || message.cancelledAt);
                            const now = new Date();
                            const timeDiff = now - messageTime;
                            
                            // Show as backlog if message is less than 24 hours old and not seen before
                            if (timeDiff < 24 * 60 * 60 * 1000) {
                                let notificationMessage = '';
                                let icon = '';
                                let colorClass = '';
                                
                                if (message.type === 'contact') {
                                    notificationMessage = `Nieuw bericht van ${message.name}: ${message.subject}`;
                                    icon = 'fas fa-envelope';
                                    colorClass = 'bg-blue-100 text-blue-800';
                                } else if (message.type === 'cancellation') {
                                    notificationMessage = `Afspraak geannuleerd: ${message.originalBooking?.name || 'Onbekend'}`;
                                    icon = 'fas fa-calendar-times';
                                    colorClass = 'bg-red-100 text-red-800';
                                }
                                
                                const existingNotification = notifications.find(n => 
                                    n.message === notificationMessage
                                );
                                
                                if (!existingNotification && notificationMessage) {
                                    addNotification(
                                        message.type, 
                                        notificationMessage, 
                                        icon, 
                                        colorClass,
                                        false // Don't play sound for backlog
                                    );
                                }
                            }
                        });
                    } else if (currentMessageCount > lastMessageCount) {
                        // New message since last check
                        const newMessages = Object.entries(messagesData)
                            .slice(-1) // Get the last message
                            .map(([id, message]) => ({ id, ...message }));
                        
                        newMessages.forEach(message => {
                            if (message.type === 'contact') {
                                addNotification(
                                    'message', 
                                    `Nieuw bericht van ${message.name}: ${message.subject}`, 
                                    'fas fa-envelope', 
                                    'bg-blue-100 text-blue-800',
                                    true // Play sound for new messages
                                );
                            } else if (message.type === 'cancellation') {
                                addNotification(
                                    'cancellation', 
                                    `Afspraak geannuleerd: ${message.originalBooking?.name || 'Onbekend'}`, 
                                    'fas fa-calendar-times',
                                    'bg-red-100 text-red-800',
                                    true // Play sound for cancellations
                                );
                            }
                        });
                    }
                    
                    lastMessageCount = currentMessageCount;
                    
                    // Update messages data
                    allMessages = Object.entries(messagesData).map(([id, message]) => ({ id, ...message }));
                    renderMessagesTable();
                    updateStats();
                }
            });

            // Set up real-time listeners for blocked dates
            const blockedDatesRef = window.firebaseRef(db, "blockedDates");
            blockedDatesListener = window.firebaseOnValue(blockedDatesRef, (snapshot) => {
                if (snapshot.exists()) {
                    const blockedDatesData = snapshot.val();
                    blockedDates = Object.entries(blockedDatesData).map(([id, block]) => ({ id, ...block }));
                } else {
                    blockedDates = [];
                }
                renderBlockedDates();
            });
            
            console.log("[v0] Real-time notifications initialized!");
        }

        function playNotificationSound() {
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
                audio.volume = 0.9;
                audio.play().catch(e => console.log('Could not play notification sound:', e));
            } catch (e) {
                console.log('Notification sound not available:', e);
            }
        }

        function addNotification(type, message, icon, colorClass, playSound = true) {
            const notification = {
                id: Date.now(),
                type: type,
                message: message,
                icon: icon,
                colorClass: colorClass,
                timestamp: new Date(),
                read: false
            };
            
            notifications.unshift(notification);
            
            // Keep only last 50 notifications
            if (notifications.length > 50) {
                notifications = notifications.slice(0, 50);
            }
            
            updateNotificationBadge();
            renderNotifications();
            saveNotifications(); // Persist to localStorage
            
            // Play notification sound only if requested
            if (playSound) {
                playNotificationSound();
            }
            
            // Show browser notification if permission granted
            if (Notification.permission === 'granted') {
                new Notification('Marc Tessens Admin', {
                    body: message,
                    icon: '/favicon.ico',
                    tag: 'admin-notification'
                });
            }
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notification-badge');
            const unreadCount = notifications.filter(n => !n.read).length;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function renderNotifications() {
            const notificationList = document.getElementById('notification-list');
            
            if (notifications.length === 0) {
                notificationList.innerHTML = '<div class="p-4 text-center text-gray-500">Geen nieuwe meldingen</div>';
                return;
            }
            
            notificationList.innerHTML = notifications.map(notification => `
                <div class="p-4 border-b border-gray-100 hover:bg-gray-50 ${notification.read ? 'opacity-60' : ''}" onclick="markNotificationRead(${notification.id})">
                    <div class="flex items-start">
                        <div class="flex-shrink-0 ${notification.colorClass} p-2 rounded-lg mr-3">
                            <i class="${notification.icon}"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900">${notification.message}</p>
                            <p class="text-xs text-gray-500">${formatNotificationTime(notification.timestamp)}</p>
                        </div>
                        ${!notification.read ? '<div class="w-2 h-2 bg-blue-500 rounded-full"></div>' : ''}
                    </div>
                </div>
            `).join('');
        }

        function formatNotificationTime(timestamp) {
            const now = new Date();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Nu';
            if (minutes < 60) return `${minutes} min geleden`;
            if (hours < 24) return `${hours} uur geleden`;
            return `${days} dagen geleden`;
        }

        window.toggleNotifications = function() {
            const dropdown = document.getElementById('notification-dropdown');
            dropdown.classList.toggle('hidden');
            
            // Request notification permission if not granted
            if (Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        window.markNotificationRead = function(notificationId) {
            const notification = notifications.find(n => n.id == notificationId);
            if (notification) {
                notification.read = true;
                updateNotificationBadge();
                renderNotifications();
                saveNotifications(); // Persist changes
            }
        }

        window.clearAllNotifications = function() {
            if (confirm('Weet je zeker dat je alle meldingen wilt wissen?')) {
                notifications = [];
                updateNotificationBadge();
                renderNotifications();
                saveNotifications();
            }
        }

        window.markAllNotificationsRead = function() {
            notifications.forEach(n => n.read = true);
            updateNotificationBadge();
            renderNotifications();
            saveNotifications(); // Persist changes
        }

        window.formatDate = function(dateString) {
            const [year, month, day] = dateString.split('-');
            const date = new Date(year, month - 1, day);
            const options = { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric'
            };
            return date.toLocaleDateString('nl-NL', options);
        }


        // Initialize admin panel
        document.addEventListener('DOMContentLoaded', () => {
            console.log("[v0] Admin panel DOM loaded");
            
            // Login form handler
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('admin-username').value;
                const password = document.getElementById('admin-password').value;
                
                // Simple authentication (in production, use proper authentication)
                if (username === 'Marc' && password === 'Admin123') {
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('admin-dashboard').classList.remove('hidden');
                    
                    // Initialize Firebase and load data
                    if (initializeFirebaseAdmin()) {
    initializeNotifications();
    loadDashboardData();
} else {
    window.addEventListener('firebaseAdminReady', () => {
        if (initializeFirebaseAdmin()) {
            initializeNotifications();
            loadDashboardData();
        }
    });
}
                } else {
                    document.getElementById('login-error').classList.remove('hidden');
                }
            });
        });

        async function loadDashboardData() {
            try {
                showLoading();
                
                // Load bookings
                const bookingsRef = window.firebaseRef(db, "bookings");
                const bookingsSnapshot = await window.firebaseGet(bookingsRef);
                
                if (bookingsSnapshot.exists()) {
                    const bookingsData = bookingsSnapshot.val();
                    allBookings = Object.entries(bookingsData).map(([id, booking]) => ({ id, ...booking }));
                    lastBookingCount = allBookings.length;
                } else {
                    allBookings = [];
                    lastBookingCount = 0;
                }
                
                // Load messages
                const messagesRef = window.firebaseRef(db, "messages");
                const messagesSnapshot = await window.firebaseGet(messagesRef);
                
                if (messagesSnapshot.exists()) {
                    const messagesData = messagesSnapshot.val();
                    allMessages = Object.entries(messagesData).map(([id, message]) => ({ id, ...message }));
                    lastMessageCount = allMessages.length;
                } else {
                    allMessages = [];
                    lastMessageCount = 0;
                }
                
                const blockedDatesRef = window.firebaseRef(db, "blockedDates");
                const blockedDatesSnapshot = await window.firebaseGet(blockedDatesRef);
                
                if (blockedDatesSnapshot.exists()) {
                    const blockedDatesData = blockedDatesSnapshot.val();
                    blockedDates = Object.entries(blockedDatesData).map(([id, block]) => ({ id, ...block }));
                } else {
                    blockedDates = [];
                }
                
                // Update UI
                filterBookings();
                renderMessagesTable();
                renderBlockedDates();
                updateStats();
                
            } catch (error) {
                console.error("[v0] Error loading dashboard data:", error);
            } finally {
                hideLoading();
            }
        }

        window.toggleManualBookingForm = function() {
            const form = document.getElementById('manual-booking-form');
            const button = document.getElementById('toggle-manual-booking');
            
            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                button.innerHTML = '<i class="fas fa-minus mr-2"></i>Sluiten';
                button.className = 'bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm';
                
                // Set minimum date to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('manual-date').min = today;
            } else {
                form.classList.add('hidden');
                button.innerHTML = '<i class="fas fa-plus mr-2"></i>Nieuwe Afspraak';
                button.className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm';
            }
        }

        window.cancelManualBooking = function() {
            document.getElementById('manual-booking-form').classList.add('hidden');
            document.getElementById('toggle-manual-booking').innerHTML = '<i class="fas fa-plus mr-2"></i>Nieuwe Afspraak';
            document.getElementById('toggle-manual-booking').className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm';
            
            // Reset form
            document.querySelector('#manual-booking-form form').reset();
        }

        window.submitManualBooking = async function(event) {
            event.preventDefault();
            
            try {
                showLoading();
                
                const name = document.getElementById('manual-name').value;
                const email = document.getElementById('manual-email').value;
                const phone = document.getElementById('manual-phone').value;
                const type = document.getElementById('manual-type').value;
                const date = document.getElementById('manual-date').value;
                const startTime = document.getElementById('manual-start-time').value;
                const endTime = document.getElementById('manual-end-time').value;
                const duration = document.getElementById('manual-duration').value;
                const notes = document.getElementById('manual-notes').value;
                
                // Calculate end time if not provided
                let finalEndTime = endTime;
                if (!endTime && duration) {
                    const [hours, minutes] = startTime.split(':').map(Number);
                    const startMinutes = hours * 60 + minutes;
                    const endMinutes = startMinutes + parseInt(duration);
                    const endHours = Math.floor(endMinutes / 60);
                    const endMins = endMinutes % 60;
                    finalEndTime = `${String(endHours).padStart(2, '0')}:${String(endMins).padStart(2, '0')}`;
                } else if (!endTime && !duration) {
                    // Default 30 minutes
                    const [hours, minutes] = startTime.split(':').map(Number);
                    const startMinutes = hours * 60 + minutes;
                    const endMinutes = startMinutes + 30;
                    const endHours = Math.floor(endMinutes / 60);
                    const endMins = endMinutes % 60;
                    finalEndTime = `${String(endHours).padStart(2, '0')}:${String(endMins).padStart(2, '0')}`;
                }
                
                const booking = {
                    name: name,
                    email: email,
                    phone: phone,
                    type: type,
                    date: date,
                    time: startTime,
                    endTime: finalEndTime,
                    duration: duration || '30',
                    notes: notes,
                    created: new Date().toISOString(),
                    isManual: true
                };
                
                // Save to Firebase
                const bookingsRef = window.firebaseRef(db, "bookings");
                const newBookingRef = window.firebasePush(bookingsRef);
                await window.firebaseSet(newBookingRef, booking);
                
                // Reset form and close
                cancelManualBooking();
                
                // Refresh data
                await loadDashboardData();
                
                alert('Afspraak succesvol toegevoegd!');
                
            } catch (error) {
                console.error('Error creating manual booking:', error);
                alert('Er is een fout opgetreden bij het toevoegen van de afspraak.');
            } finally {
                hideLoading();
            }
        }

        window.toggleDateBlockingForm = function() {
            const form = document.getElementById('date-blocking-form');
            const button = document.getElementById('toggle-date-blocking');
            
            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                button.innerHTML = '<i class="fas fa-minus mr-2"></i>Sluiten';
                button.className = 'bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm';
                
                // Set minimum date to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('block-start-date').min = today;
                document.getElementById('block-end-date').min = today;
            } else {
                form.classList.add('hidden');
                button.innerHTML = '<i class="fas fa-ban mr-2"></i>Datum Blokkeren';
                button.className = 'bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm';
            }
        }

        window.cancelDateBlocking = function() {
            document.getElementById('date-blocking-form').classList.add('hidden');
            document.getElementById('toggle-date-blocking').innerHTML = '<i class="fas fa-ban mr-2"></i>Datum Blokkeren';
            document.getElementById('toggle-date-blocking').className = 'bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm';
            
            // Reset form
            document.querySelector('#date-blocking-form form').reset();
        }

        window.submitDateBlocking = async function(event) {
            event.preventDefault();
            
            try {
                showLoading();
                
                const startDate = document.getElementById('block-start-date').value;
                const endDate = document.getElementById('block-end-date').value || startDate;
                const startTime = document.getElementById('block-start-time').value;
                const endTime = document.getElementById('block-end-time').value;
                const reason = document.getElementById('block-reason').value;
                
                const dateBlock = {
                    startDate: startDate,
                    endDate: endDate,
                    startTime: startTime,
                    endTime: endTime,
                    reason: reason,
                    created: new Date().toISOString()
                };
                
                // Save to Firebase
                const blockedDatesRef = window.firebaseRef(db, "blockedDates");
                const newBlockRef = window.firebasePush(blockedDatesRef);
                await window.firebaseSet(newBlockRef, dateBlock);
                
                // Reset form and close
                cancelDateBlocking();
                
                // Refresh data
                await loadDashboardData();
                
                alert('Datum succesvol geblokkeerd!');
                
            } catch (error) {
                console.error('Error blocking date:', error);
                alert('Er is een fout opgetreden bij het blokkeren van de datum.');
            } finally {
                hideLoading();
            }
        }

        function renderBlockedDates() {
            const container = document.getElementById('blocked-dates-container');
            
            if (blockedDates.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Geen geblokkeerde datums</p>';
                return;
            }
            
            // Sort blocked dates by start date
            const sortedBlocks = [...blockedDates].sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
            
            container.innerHTML = sortedBlocks.map(block => {
                const startDate = new Date(block.startDate).toLocaleDateString('nl-NL');
                const endDate = block.endDate !== block.startDate ? 
                    ` - ${new Date(block.endDate).toLocaleDateString('nl-NL')}` : '';
                const timeRange = block.startTime && block.endTime ? 
                    ` (${block.startTime} - ${block.endTime})` : 
                    block.startTime ? ` (vanaf ${block.startTime})` : '';
                
                return `
                    <div class="flex items-center justify-between bg-red-50 border border-red-200 rounded-lg p-3">
                        <div>
                            <div class="font-medium text-red-800">${startDate}${endDate}${timeRange}</div>
                            <div class="text-sm text-red-600">${block.reason}</div>
                        </div>
                        <button onclick="removeBlockedDate('${block.id}')" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        window.removeBlockedDate = async function(blockId) {
            if (confirm('Weet je zeker dat je deze blokkering wilt verwijderen?')) {
                try {
                    showLoading();
                    const blockRef = window.firebaseRef(db, `blockedDates/${blockId}`);
                    await window.firebaseRemove(blockRef);
                    
                    blockedDates = blockedDates.filter(b => b.id !== blockId);
                    renderBlockedDates();
                    
                    alert('Blokkering succesvol verwijderd!');
                } catch (error) {
                    console.error('Error removing blocked date:', error);
                    alert('Er is een fout opgetreden bij het verwijderen van de blokkering.');
                } finally {
                    hideLoading();
                }
            }
        }

        window.showLoading = function() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.classList.remove('hidden');
            }
        }

        window.hideLoading = function() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.classList.add('hidden');
            }
        }

        window.refreshDashboard = async function() {
            console.log("[v0] Refreshing dashboard...");
            await loadDashboardData();
        }

        window.adminLogout = function() {
            if (confirm('Weet je zeker dat je wilt uitloggen?')) {
                // Clean up listeners
                if (bookingsListener) {
                    window.firebaseOff(window.firebaseRef(db, "bookings"), bookingsListener);
                }
                if (messagesListener) {
                    window.firebaseOff(window.firebaseRef(db, "messages"), messagesListener);
                }
                if (blockedDatesListener) {
                    window.firebaseOff(window.firebaseRef(db, "blockedDates"), blockedDatesListener);
                }
                
                // Reset data
                allBookings = [];
                allMessages = [];
                blockedDates = [];
                notifications = [];
                
                // Show login screen
                document.getElementById('admin-dashboard').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
                
                // Reset login form
                document.getElementById('admin-username').value = '';
                document.getElementById('admin-password').value = '';
                document.getElementById('login-error').classList.add('hidden');
            }
        }

        window.filterBookings = function() {
            const filterStatus = document.getElementById('filter-status').value;
            const now = new Date();
            const today = now.getFullYear() + '-' + 
                String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                String(now.getDate()).padStart(2, '0');
            
            switch (filterStatus) {
                case 'upcoming':
                    filteredBookings = allBookings.filter(booking => {
                        const bookingDateTime = new Date(booking.date + 'T' + booking.time);
                        return bookingDateTime >= now;
                    });
                    break;
                case 'today':
                    filteredBookings = allBookings.filter(booking => booking.date === today);
                    break;
                case 'past':
                    filteredBookings = allBookings.filter(booking => {
                        const bookingDateTime = new Date(booking.date + 'T' + booking.time);
                        return bookingDateTime < now;
                    });
                    break;
                default:
                    filteredBookings = [...allBookings];
            }
            
            renderBookingsTable();
        }

        window.resetAllBookings = async function() {
            if (confirm('WAARSCHUWING: Dit zal ALLE afspraken permanent verwijderen. Weet je dit zeker?')) {
                if (confirm('Dit kan niet ongedaan gemaakt worden. Laatste kans om te annuleren.')) {
                    try {
                        showLoading();
                        const bookingsRef = window.firebaseRef(db, "bookings");
                        await window.firebaseRemove(bookingsRef);
                        
                        allBookings = [];
                        filteredBookings = [];
                        renderBookingsTable();
                        updateStats();
                        
                        alert('Alle afspraken zijn verwijderd.');
                    } catch (error) {
                        console.error('Error resetting bookings:', error);
                        alert('Er is een fout opgetreden bij het verwijderen van afspraken.');
                    } finally {
                        hideLoading();
                    }
                }
            }
        }

        window.deleteBooking = async function(bookingId) {
            if (confirm('Weet je zeker dat je deze afspraak wilt verwijderen?')) {
                try {
                    showLoading();
                    const bookingRef = window.firebaseRef(db, `bookings/${bookingId}`);
                    await window.firebaseRemove(bookingRef);
                    
                    allBookings = allBookings.filter(b => b.id !== bookingId);
                    filterBookings();
                    updateStats();
                    
                    alert('Afspraak succesvol verwijderd!');
                } catch (error) {
                    console.error('Error deleting booking:', error);
                    alert('Er is een fout opgetreden bij het verwijderen van de afspraak.');
                } finally {
                    hideLoading();
                }
            }
        }

        function getBookingTypeText(type) {
            const types = {
                'startup': 'Startersadvies',
                'bookkeeping': 'Boekhouding',
                'tax': 'Fiscaal Advies',
                'payroll': 'Loonbeheer',
                'other': 'Andere'
            };
            return types[type] || type;
        }

        function updateStats() {
            const now = new Date();
            const today = now.getFullYear() + '-' + 
                String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                String(now.getDate()).padStart(2, '0');
            
            const totalBookings = allBookings.length;
            const upcomingBookings = allBookings.filter(booking => {
                const bookingDateTime = new Date(booking.date + 'T' + booking.time);
                return bookingDateTime >= now;
            }).length;
            const todayBookings = allBookings.filter(booking => booking.date === today).length;
            const totalMessages = allMessages.length;
            
            document.getElementById('total-bookings').textContent = totalBookings;
            document.getElementById('upcoming-bookings').textContent = upcomingBookings;
            document.getElementById('today-bookings').textContent = todayBookings;
            document.getElementById('total-messages').textContent = totalMessages;
        }

        function renderMessagesTable() {
            const tbody = document.getElementById('messages-table-body');
            const noMessages = document.getElementById('no-messages');
            
            if (allMessages.length === 0) {
                tbody.innerHTML = '';
                noMessages.classList.remove('hidden');
                return;
            }
            
            noMessages.classList.add('hidden');
            
            // Sort messages by date (newest first)
            const sortedMessages = [...allMessages].sort((a, b) => {
                const dateA = new Date(a.created || a.cancelledAt);
                const dateB = new Date(b.created || b.cancelledAt);
                return dateB - dateA;
            });
            
            tbody.innerHTML = sortedMessages.map(message => {
                const messageDate = new Date(message.created || message.cancelledAt);
                const typeText = message.type === 'contact' ? 'Contact' : 'Annulering';
                const typeClass = message.type === 'contact' ? 'bg-blue-100 text-blue-800' : 'bg-red-100 text-red-800';
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${messageDate.toLocaleDateString('nl-NL')} ${messageDate.toLocaleTimeString('nl-NL', {hour: '2-digit', minute: '2-digit'})}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${message.name}</div>
                            <div class="text-sm text-gray-500">${message.email}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${message.subject || (message.type === 'cancellation' ? 'Afspraak annulering' : 'Geen onderwerp')}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${typeClass}">
                                ${typeText}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="viewMessageDetails('${message.id}')" class="text-blue-600 hover:text-blue-900 mr-3">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="deleteMessage('${message.id}')" class="text-red-600 hover:text-red-900">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        window.viewMessageDetails = function(messageId) {
            const message = allMessages.find(m => m.id === messageId);
            if (message) {
                if (message.type === 'contact') {
                    alert(`Bericht Details:\n\nVan: ${message.name}\nEmail: ${message.email}\nOnderwerp: ${message.subject}\nBericht: ${message.message}\nDatum: ${new Date(message.created).toLocaleString('nl-NL')}`);
                } else if (message.type === 'cancellation') {
                    const originalBooking = message.originalBooking;
                    alert(`Annulering Details:\n\nVan: ${message.name}\nEmail: ${message.email}\nReden: ${message.reason || 'Geen reden opgegeven'}\nOriginele afspraak: ${originalBooking ? `${originalBooking.name} op ${formatDate(originalBooking.date)} om ${originalBooking.time}` : 'Onbekend'}\nDatum annulering: ${new Date(message.cancelledAt).toLocaleString('nl-NL')}`);
                }
            }
        }

        window.deleteMessage = async function(messageId) {
            if (confirm('Weet je zeker dat je dit bericht wilt verwijderen?')) {
                try {
                    showLoading();
                    const messageRef = window.firebaseRef(db, `messages/${messageId}`);
                    await window.firebaseRemove(messageRef);
                    
                    allMessages = allMessages.filter(m => m.id !== messageId);
                    renderMessagesTable();
                    updateStats();
                    
                    alert('Bericht succesvol verwijderd!');
                } catch (error) {
                    console.error('Error deleting message:', error);
                    alert('Er is een fout opgetreden bij het verwijderen van het bericht.');
                } finally {
                    hideLoading();
                }
            }
        }

        // Close notification dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('notification-dropdown');
            const button = event.target.closest('[onclick="toggleNotifications()"]');
            
            if (!button && !dropdown.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
        });

        function renderBookingsTable() {
            console.log('[v0] Rendering bookings table');
            const tableBody = document.querySelector('#bookings-table-body');
            if (!tableBody) {
                console.error('[v0] Bookings table body not found');
                return;
            }

            // Clear existing content
            tableBody.innerHTML = '';

            if (!filteredBookings || filteredBookings.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Geen afspraken gevonden</td></tr>';
                document.getElementById('no-bookings').classList.remove('hidden');
                return;
            }

            document.getElementById('no-bookings').classList.add('hidden');

            // Sort bookings by date and time
            const sortedBookings = [...filteredBookings].sort((a, b) => {
                const dateA = new Date(a.date + ' ' + a.time);
                const dateB = new Date(b.date + ' ' + b.time);
                return dateA - dateB;
            });

            sortedBookings.forEach(booking => {
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-50');
                const endTime = booking.endTime || calculateEndTime(booking.time, booking.duration || 30);
                const isManual = booking.isManual ? ' (Handmatig)' : '';
                const bookingDate = new Date(booking.date);
                const formattedDate = bookingDate.toLocaleDateString('nl-NL', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formattedDate}<br>${booking.time} - ${endTime}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${booking.name}${isManual}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${getBookingTypeText(booking.type)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${booking.email}<br>${booking.phone || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                            Actief
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="viewBookingDetails('${booking.id}')" class="text-blue-600 hover:text-blue-900 mr-3">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="deleteBooking('${booking.id}')" class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function calculateEndTime(startTime, duration) {
            const [hours, minutes] = startTime.split(':').map(Number);
            const startMinutes = hours * 60 + minutes;
            const endMinutes = startMinutes + duration;
            const endHours = Math.floor(endMinutes / 60);
            const endMins = endMinutes % 60;
            return `${endHours.toString().padStart(2, '0')}:${endMins.toString().padStart(2, '0')}`;
        }

        window.viewBookingDetails = function(bookingId) {
            const booking = allBookings.find(b => b.id === bookingId);
            if (booking) {
                const bookingDate = new Date(booking.date);
                const formattedDate = bookingDate.toLocaleDateString('nl-NL', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                const endTime = booking.endTime || calculateEndTime(booking.time, booking.duration || 30);
                alert(`Afspraak Details:\n\nNaam: ${booking.name}\nEmail: ${booking.email}\nTelefoon: ${booking.phone || 'Niet opgegeven'}\nType: ${getBookingTypeText(booking.type)}\nDatum: ${formattedDate}\nTijd: ${booking.time} - ${endTime}\nNotities: ${booking.notes || 'Geen notities'}`);
            }
        }
    </script>
</body>
</html>
